<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORTAL ARENA</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Bangers', cursive;
            overflow: hidden;
            background: radial-gradient(circle at center, #1a0a0a 0%, #000000 100%);
        }

        #gameContainer {
            position: relative;
            width: 1000px;
            height: 600px;
            background: #000;
            border: 6px solid #ff0000;
            box-shadow: 
                0 0 20px #ff0000,
                0 0 40px #ff0000,
                0 0 60px rgba(255, 0, 0, 0.5),
                inset 0 0 20px rgba(255, 0, 0, 0.2);
            animation: borderPulse 2s infinite;
        }

        @keyframes borderPulse {
            0%, 100% { box-shadow: 0 0 20px #ff0000, 0 0 40px #ff0000, 0 0 60px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 30px #ff0000, 0 0 60px #ff0000, 0 0 90px rgba(255, 0, 0, 0.7); }
        }

        canvas {
            display: block;
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px;
            pointer-events: none;
            z-index: 10;
        }

        .health-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 10px;
        }

        .player-info {
            flex: 1;
            max-width: 420px;
        }

        .player-name {
            color: #ffff00;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 
                3px 3px 0px #ff0000,
                6px 6px 0px #000,
                0 0 20px #ffff00;
            margin-bottom: 8px;
            letter-spacing: 3px;
            transform: skew(-5deg);
        }

        .player2 .player-name {
            text-align: right;
        }

        .health-bar-container {
            position: relative;
            background: linear-gradient(to bottom, #000 0%, #1a1a1a 100%);
            border: 4px solid #ffff00;
            box-shadow: 
                0 0 10px #ffff00,
                inset 0 0 10px rgba(0,0,0,0.9);
            height: 45px;
            overflow: hidden;
        }

        .health-bar-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                #1a1a1a 0px,
                #2a2a2a 2px,
                #1a1a1a 4px
            );
        }

        .health-bar-inner {
            position: relative;
            height: 100%;
            background: linear-gradient(to bottom, 
                #00ff00 0%, 
                #00dd00 20%,
                #00bb00 50%, 
                #009900 80%,
                #007700 100%);
            transition: width 0.3s ease-out;
            box-shadow: 
                inset 0 0 20px rgba(255, 255, 255, 0.4),
                0 0 20px rgba(0, 255, 0, 0.6);
            border-right: 3px solid rgba(0, 0, 0, 0.5);
        }

        .health-bar-inner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to bottom, 
                rgba(255,255,255,0.6), 
                transparent);
        }

        .health-bar-inner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent 0px,
                rgba(255,255,255,0.1) 1px,
                transparent 2px
            );
        }

        .health-bar-inner.low {
            background: linear-gradient(to bottom, 
                #ffff00 0%, 
                #ffdd00 25%,
                #ffbb00 50%, 
                #ff9900 75%,
                #ff7700 100%);
            box-shadow: 
                inset 0 0 20px rgba(255, 255, 255, 0.4),
                0 0 20px rgba(255, 200, 0, 0.6);
        }

        .health-bar-inner.critical {
            background: linear-gradient(to bottom, 
                #ff0000 0%, 
                #dd0000 25%,
                #bb0000 50%, 
                #990000 75%,
                #770000 100%);
            animation: criticalPulse 0.5s infinite;
            box-shadow: 
                inset 0 0 20px rgba(255, 255, 255, 0.4),
                0 0 30px rgba(255, 0, 0, 0.8);
        }

        @keyframes criticalPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #timer {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 72px;
            color: #ffff00;
            text-shadow: 
                4px 4px 0px #ff0000,
                8px 8px 0px #000,
                0 0 30px #ffff00,
                0 0 50px #ff0000;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
            letter-spacing: 5px;
        }

        #timer.warning {
            color: #ff0000;
            animation: timerWarning 0.5s infinite;
        }

        @keyframes timerWarning {
            0%, 100% { 
                transform: translateX(-50%) scale(1); 
                text-shadow: 
                    4px 4px 0px #000,
                    0 0 30px #ff0000,
                    0 0 50px #ff0000;
            }
            50% { 
                transform: translateX(-50%) scale(1.15); 
                text-shadow: 
                    6px 6px 0px #000,
                    0 0 50px #ff0000,
                    0 0 80px #ff0000;
            }
        }

        #roundText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            color: #ffff00;
            text-shadow: 
                6px 6px 0px #ff0000,
                12px 12px 0px #000,
                0 0 40px #ffff00,
                0 0 80px #ff0000;
            font-weight: bold;
            display: none;
            z-index: 100;
            letter-spacing: 10px;
        }

        .show-text {
            display: block !important;
            animation: textExplosion 2s forwards;
        }

        @keyframes textExplosion {
            0% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.2) rotate(-10deg);
            }
            20% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.4) rotate(5deg);
            }
            40% {
                transform: translate(-50%, -50%) scale(1.2) rotate(-2deg);
            }
            80% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.15) rotate(0deg);
            }
            100% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
            }
        }

        #controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 0, 0.7);
            font-size: 14px;
            text-align: center;
            text-shadow: 2px 2px 4px #000;
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.7);
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 0, 0.3);
        }

        #winText {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            color: #ffff00;
            text-shadow: 
                6px 6px 0px #ff0000,
                12px 12px 0px #000,
                0 0 40px #ffff00,
                0 0 80px #ff0000;
            font-weight: bold;
            display: none;
            z-index: 100;
            letter-spacing: 8px;
            animation: winnerAnnounce 1s forwards;
        }

        @keyframes winnerAnnounce {
            0% { 
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        #debugToggle, #fpsCounter {
            position: absolute;
            right: 20px;
            color: #0f0;
            font-size: 11px;
            font-family: monospace;
            pointer-events: all;
            cursor: pointer;
            background: rgba(0,0,0,0.8);
            padding: 4px 8px;
            border: 1px solid #0f0;
        }

        #debugToggle { top: 100px; }
        #fpsCounter { top: 125px; }

        .combo-text {
            position: absolute;
            font-size: 48px;
            color: #ffff00;
            text-shadow: 
                3px 3px 0px #ff0000,
                6px 6px 0px #000;
            font-weight: bold;
            pointer-events: none;
            z-index: 50;
            animation: comboFloat 1s forwards;
        }

        @keyframes comboFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.5);
            }
            50% {
                transform: translateY(-30px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(1);
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="1000" height="600"></canvas>
        <div id="ui">
            <div class="health-container">
                <div class="player-info player1">
                    <div class="player-name">SCORPION</div>
                    <div class="health-bar-container">
                        <div class="health-bar-bg"></div>
                        <div class="health-bar-inner" id="health1"></div>
                    </div>
                </div>
                <div class="player-info player2">
                    <div class="player-name">SUB-ZERO</div>
                    <div class="health-bar-container">
                        <div class="health-bar-bg"></div>
                        <div class="health-bar-inner" id="health2"></div>
                    </div>
                </div>
            </div>
            <div id="timer">99</div>
            <div id="roundText">FIGHT!</div>
            <div id="winText"></div>
            <div id="debugToggle">DEBUG: OFF (Ctrl+D)</div>
            <div id="fpsCounter">FPS: 60</div>
            <div id="controls">
                P1: A/D-Move | W-Jump | S-Duck | J-Punch | K-Kick | L-Special<br>
                P2: ←/→-Move | ↑-Jump | ↓-Duck | 1-Punch | 2-Kick | 3-Special
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        
        const game = {
            state: 'ready',
            timer: 99,
            debug: false,
            paused: false,
            winner: null
        };

        const keys = {};
        const keyPressed = {};

        let fps = 60;
        let lastTime = performance.now();
        let frames = 0;
        let fpsTime = 0;

        class Vector2 {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }
        }

        class Rectangle {
            constructor(x, y, w, h) {
                this.x = x;
                this.y = y;
                this.width = w;
                this.height = h;
            }

            intersects(other) {
                return this.x < other.x + other.width &&
                       this.x + this.width > other.x &&
                       this.y < other.y + other.height &&
                       this.y + this.height > other.y;
            }

            draw(color = '#ff0000', alpha = 0.5) {
                if (!game.debug) return;
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(this.x, this.y, this.width, this.height);
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, vx, vy, color, life = 30, size = 4, shape = 'square') {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.color = color;
                this.life = life;
                this.maxLife = life;
                this.size = size;
                this.shape = shape;
                this.gravity = 0.4;
                this.rotation = Math.random() * Math.PI * 2;
                this.rotationSpeed = (Math.random() - 0.5) * 0.3;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += this.gravity;
                this.vx *= 0.97;
                this.rotation += this.rotationSpeed;
                this.life--;
            }

            draw() {
                const alpha = this.life / this.maxLife;
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                if (this.shape === 'circle') {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
                }
                
                ctx.restore();
            }

            isDead() {
                return this.life <= 0;
            }
        }

        const particles = [];

        function createHitEffect(x, y, color, intense = false) {
            const count = intense ? 30 : 20;
            const speed = intense ? 8 : 6;
            
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 * i) / count;
                const s = speed * (0.5 + Math.random() * 0.5);
                const shape = Math.random() > 0.5 ? 'circle' : 'square';
                particles.push(new Particle(
                    x, y,
                    Math.cos(angle) * s,
                    Math.sin(angle) * s,
                    color,
                    25 + Math.random() * 15,
                    4 + Math.random() * 4,
                    shape
                ));
            }

            // Add extra sparkles for intense hits
            if (intense) {
                for (let i = 0; i < 15; i++) {
                    particles.push(new Particle(
                        x + (Math.random() - 0.5) * 40,
                        y + (Math.random() - 0.5) * 40,
                        (Math.random() - 0.5) * 12,
                        (Math.random() - 0.5) * 12 - 3,
                        '#ffffff',
                        30,
                        3,
                        'circle'
                    ));
                }
            }
        }

        function showComboText(text, x, y) {
            const el = document.createElement('div');
            el.className = 'combo-text';
            el.textContent = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.getElementById('gameContainer').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        const STATE = {
            IDLE: 'idle',
            WALK: 'walk',
            JUMP: 'jump',
            DUCK: 'duck',
            PUNCH: 'punch',
            KICK: 'kick',
            SPECIAL: 'special',
            HIT: 'hit',
            BLOCK: 'block'
        };

        class Fighter {
            constructor(x, y, name, colors, controls, facingRight = true) {
                this.pos = new Vector2(x, y);
                this.vel = new Vector2(0, 0);
                this.facing = facingRight ? 1 : -1;
                
                this.width = 80;
                this.height = 140;
                this.groundY = 430;
                
                this.health = 100;
                this.maxHealth = 100;
                this.combo = 0;
                
                this.state = STATE.IDLE;
                this.prevState = STATE.IDLE;
                this.stateTimer = 0;
                this.animFrame = 0;
                
                this.isGrounded = true;
                this.canMove = true;
                this.invincible = false;
                this.stunned = false;
                
                this.attackCooldown = 0;
                this.hitStunTimer = 0;
                this.invincibleTimer = 0;
                
                this.name = name;
                this.colors = colors;
                this.controls = controls;
                
                this.hurtbox = new Rectangle(0, 0, 60, 120);
                this.hitbox = null;
                
                this.trail = [];
            }

            setState(newState, duration = 0) {
                if (this.state !== newState) {
                    this.prevState = this.state;
                    this.state = newState;
                    this.stateTimer = duration;
                }
            }

            updateHurtbox() {
                const offsetX = 10;
                const offsetY = 10;
                this.hurtbox.x = this.pos.x + offsetX;
                this.hurtbox.y = this.pos.y + offsetY;
                
                if (this.state === STATE.DUCK) {
                    this.hurtbox.height = 70;
                    this.hurtbox.y = this.pos.y + 60;
                } else {
                    this.hurtbox.height = 120;
                }
            }

            createHitbox(offsetX, offsetY, width, height) {
                const actualOffsetX = offsetX * this.facing;
                this.hitbox = new Rectangle(
                    this.pos.x + this.width/2 + actualOffsetX,
                    this.pos.y + offsetY,
                    width,
                    height
                );
            }

            clearHitbox() {
                this.hitbox = null;
            }

            takeDamage(damage, knockbackX = 0, knockbackY = 0, isSpecial = false) {
                if (this.invincible || this.state === STATE.BLOCK) return false;
                
                this.health -= damage;
                this.health = Math.max(0, this.health);
                this.combo = 0;
                
                this.setState(STATE.HIT, 20);
                this.hitStunTimer = 20;
                this.stunned = true;
                this.canMove = false;
                
                this.vel.x = knockbackX * this.facing;
                this.vel.y = knockbackY;
                
                this.invincible = true;
                this.invincibleTimer = 30;
                
                const hitX = this.pos.x + this.width/2;
                const hitY = this.pos.y + this.height/2;
                createHitEffect(hitX, hitY, isSpecial ? '#ffff00' : '#ff0000', isSpecial);
                
                return true;
            }

            update(opponent) {
                this.animFrame++;
                this.stateTimer--;
                
                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.hitStunTimer > 0) {
                    this.hitStunTimer--;
                    if (this.hitStunTimer === 0) {
                        this.stunned = false;
                        this.canMove = true;
                    }
                }
                if (this.invincibleTimer > 0) {
                    this.invincibleTimer--;
                    if (this.invincibleTimer === 0) {
                        this.invincible = false;
                    }
                }
                
                this.facing = this.pos.x < opponent.pos.x ? 1 : -1;
                
                if (!this.stunned && this.canMove && game.state === 'playing') {
                    this.handleInput(opponent);
                }
                
                this.vel.y += 0.8;
                this.pos.x += this.vel.x;
                this.pos.y += this.vel.y;
                
                if (this.pos.y >= this.groundY) {
                    this.pos.y = this.groundY;
                    this.vel.y = 0;
                    this.isGrounded = true;
                    
                    if (this.state === STATE.JUMP) {
                        this.setState(STATE.IDLE);
                    }
                } else {
                    this.isGrounded = false;
                }
                
                this.pos.x = Math.max(20, Math.min(900, this.pos.x));
                
                this.vel.x *= 0.85;
                
                if (this.stateTimer <= 0 && this.canMove) {
                    if ([STATE.PUNCH, STATE.KICK, STATE.SPECIAL, STATE.HIT].includes(this.state)) {
                        this.setState(STATE.IDLE);
                        this.clearHitbox();
                    }
                }
                
                this.updateHurtbox();
                
                // Motion trail
                if (this.state === STATE.SPECIAL || this.vel.x !== 0) {
                    this.trail.push({
                        x: this.pos.x,
                        y: this.pos.y,
                        alpha: 0.3
                    });
                    if (this.trail.length > 5) this.trail.shift();
                }
                
                this.trail.forEach(t => t.alpha *= 0.8);
                this.trail = this.trail.filter(t => t.alpha > 0.01);
            }

            handleInput(opponent) {
                const c = this.controls;
                
                if (this.isGrounded && this.attackCooldown === 0) {
                    if (keys[c.left]) {
                        this.vel.x = -5.5;
                        if (this.state === STATE.IDLE) this.setState(STATE.WALK);
                    } else if (keys[c.right]) {
                        this.vel.x = 5.5;
                        if (this.state === STATE.IDLE) this.setState(STATE.WALK);
                    } else {
                        if (this.state === STATE.WALK) this.setState(STATE.IDLE);
                    }
                    
                    if (keys[c.duck]) {
                        this.setState(STATE.DUCK);
                        this.vel.x = 0;
                    } else if (this.state === STATE.DUCK) {
                        this.setState(STATE.IDLE);
                    }
                }
                
                if (keyPressed[c.jump] && this.isGrounded && this.attackCooldown === 0) {
                    this.vel.y = -17;
                    this.setState(STATE.JUMP);
                    keyPressed[c.jump] = false;
                }
                
                if (this.attackCooldown === 0) {
                    if (keyPressed[c.punch]) {
                        this.performPunch(opponent);
                        keyPressed[c.punch] = false;
                    } else if (keyPressed[c.kick]) {
                        this.performKick(opponent);
                        keyPressed[c.kick] = false;
                    } else if (keyPressed[c.special]) {
                        this.performSpecial(opponent);
                        keyPressed[c.special] = false;
                    }
                }
            }

            performPunch(opponent) {
                this.setState(STATE.PUNCH, 15);
                this.attackCooldown = 20;
                this.vel.x = 0;
                
                setTimeout(() => {
                    if (this.state === STATE.PUNCH) {
                        this.createHitbox(40, 35, 35, 20);
                        this.checkHit(opponent, 6, 10, -2, false);
                    }
                }, 80);
                
                setTimeout(() => this.clearHitbox(), 150);
            }

            performKick(opponent) {
                this.setState(STATE.KICK, 20);
                this.attackCooldown = 25;
                this.vel.x = 0;
                
                setTimeout(() => {
                    if (this.state === STATE.KICK) {
                        this.createHitbox(45, 70, 40, 20);
                        this.checkHit(opponent, 9, 12, -3, false);
                    }
                }, 100);
                
                setTimeout(() => this.clearHitbox(), 200);
            }

            performSpecial(opponent) {
                this.setState(STATE.SPECIAL, 30);
                this.attackCooldown = 50;
                this.vel.x = 0;
                
                // Charge effect
                for (let i = 0; i < 25; i++) {
                    const angle = (Math.PI * 2 * i) / 25;
                    particles.push(new Particle(
                        this.pos.x + this.width/2,
                        this.pos.y + this.height/2,
                        Math.cos(angle) * 6,
                        Math.sin(angle) * 6,
                        this.colors.secondary,
                        35,
                        6,
                        'circle'
                    ));
                }
                
                setTimeout(() => {
                    if (this.state === STATE.SPECIAL) {
                        this.createHitbox(50, 40, 60, 50);
                        this.checkHit(opponent, 18, 18, -10, true);
                    }
                }, 150);
                
                setTimeout(() => this.clearHitbox(), 300);
            }

            checkHit(opponent, damage, knockbackX, knockbackY, isSpecial) {
                if (this.hitbox && this.hitbox.intersects(opponent.hurtbox)) {
                    const hit = opponent.takeDamage(damage, -knockbackX, knockbackY, isSpecial);
                    if (hit) {
                        this.combo++;
                        if (this.combo > 1) {
                            showComboText(`${this.combo} HIT COMBO!`, this.pos.x, this.pos.y - 50);
                        }
                        if (isSpecial) {
                            showComboText('SPECIAL!', opponent.pos.x, opponent.pos.y - 80);
                        }
                        updateHealthBars();
                        checkWinCondition();
                    }
                }
            }

            draw() {
                ctx.save();
                
                // Motion trail
                this.trail.forEach(t => {
                    ctx.globalAlpha = t.alpha * 0.5;
                    this.drawCharacter(t.x, t.y, 0, true);
                });
                
                ctx.globalAlpha = 1;
                
                if (this.invincible && Math.floor(this.animFrame / 3) % 2 === 0) {
                    ctx.globalAlpha = 0.6;
                }
                
                const bobOffset = this.state === STATE.WALK ? Math.sin(this.animFrame / 4) * 3 : 0;
                
                this.drawCharacter(this.pos.x, this.pos.y, bobOffset, false);
                
                if (game.debug) {
                    this.hurtbox.draw('#00ff00', 0.3);
                    if (this.hitbox) this.hitbox.draw('#ff0000', 0.5);
                }
                
                ctx.restore();
            }

            drawCharacter(x, y, bobOffset, isTrail) {
                const scale = this.facing;
                
                ctx.save();
                ctx.translate(x + this.width/2, y + this.height/2);
                if (scale < 0) ctx.scale(-1, 1);
                ctx.translate(-this.width/2, -this.height/2);
                
                const drawY = this.state === STATE.DUCK ? 50 : 0;
                const isDucking = this.state === STATE.DUCK;
                
                // Add outline for depth
                if (!isTrail) {
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.lineWidth = 2;
                }
                
                // === LEGS ===
                ctx.fillStyle = this.colors.primary;
                if (this.state === STATE.KICK) {
                    // Kicking pose
                    ctx.fillRect(25, 80 + drawY, 16, 45);
                    ctx.fillRect(55, 92 + drawY, 38, 14);
                    
                    // Boot on extended leg
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(88, 90 + drawY, 16, 18);
                    
                    // Shadow/motion lines for kick
                    if (!isTrail) {
                        ctx.strokeStyle = this.colors.secondary;
                        ctx.lineWidth = 3;
                        ctx.globalAlpha = 0.5;
                        for (let i = 0; i < 3; i++) {
                            ctx.beginPath();
                            ctx.moveTo(60 + i * 8, 99 + drawY);
                            ctx.lineTo(85 + i * 8, 99 + drawY);
                            ctx.stroke();
                        }
                        ctx.globalAlpha = 1;
                    }
                } else if (this.state !== STATE.DUCK) {
                    // Normal stance legs
                    const legOffset = Math.sin(this.animFrame / 6) * 2;
                    ctx.fillRect(23, 85 + bobOffset, 16, 48);
                    ctx.fillRect(41, 85 + bobOffset + legOffset, 16, 48);
                    
                    // Boots
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(20, 123 + bobOffset, 20, 14);
                    ctx.fillRect(40, 123 + bobOffset + legOffset, 20, 14);
                } else {
                    // Crouched legs
                    ctx.fillRect(18, 60, 46, 30);
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(18, 85, 46, 12);
                }
                
                // Torso with armor details
                ctx.fillStyle = this.colors.primary;
                ctx.fillRect(18, 38 + drawY, 44, 50);
                
                // Armor plating
                ctx.fillStyle = this.colors.secondary;
                ctx.fillRect(22, 42 + drawY, 36, 10);
                ctx.fillRect(26, 58 + drawY, 12, 22);
                ctx.fillRect(42, 58 + drawY, 12, 22);
                
                // Belt with buckle
                ctx.fillStyle = '#6B4423';
                ctx.fillRect(18, 78 + drawY, 44, 10);
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(34, 78 + drawY, 12, 10);
                
                // Enhanced glow on belt buckle
                if (!isTrail) {
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.4)';
                    ctx.fillRect(32, 76 + drawY, 16, 14);
                }
                
                // Arms
                ctx.fillStyle = this.colors.skin;
                if (this.state === STATE.PUNCH) {
                    // Punching arm extended
                    const armX = 65;
                    ctx.fillRect(armX, 46, 32, 14);
                    
                    // Fist
                    ctx.fillStyle = this.colors.primary;
                    ctx.fillRect(armX + 28, 44, 14, 18);
                    
                    // Punch impact lines
                    if (!isTrail) {
                        ctx.strokeStyle = '#ffff00';
                        ctx.lineWidth = 4;
                        ctx.globalAlpha = 0.7;
                        for (let i = 0; i < 3; i++) {
                            ctx.beginPath();
                            ctx.moveTo(armX + 35 + i * 6, 53);
                            ctx.lineTo(armX + 50 + i * 6, 53);
                            ctx.stroke();
                        }
                        ctx.globalAlpha = 1;
                    }
                    
                    // Other arm
                    ctx.fillStyle = this.colors.skin;
                    ctx.fillRect(12, 52 + bobOffset, 15, 14);
                } else if (this.state === STATE.SPECIAL) {
                    // Both arms forward for special
                    ctx.fillRect(8, 48, 16, 14);
                    ctx.fillRect(56, 48, 16, 14);
                    ctx.fillRect(5, 58, 14, 18);
                    ctx.fillRect(61, 58, 14, 18);
                    
                    // Energy glow
                    if (!isTrail) {
                        ctx.fillStyle = this.colors.secondary;
                        ctx.globalAlpha = 0.6 + Math.sin(this.animFrame / 3) * 0.4;
                        ctx.fillRect(68, 60, 20, 20);
                        ctx.fillRect(72, 55, 24, 30);
                        ctx.globalAlpha = 1;
                    }
                    
                    ctx.fillStyle = this.colors.primary;
                    ctx.fillRect(3, 74, 16, 12);
                    ctx.fillRect(61, 74, 16, 12);
                } else {
                    // Normal arms
                    ctx.fillRect(8, 48 + bobOffset, 15, 14);
                    ctx.fillRect(57, 48 + bobOffset, 15, 14);
                    ctx.fillRect(3, 58 + bobOffset, 14, 20);
                    ctx.fillRect(63, 58 + bobOffset, 14, 20);
                    
                    // Gloves
                    ctx.fillStyle = this.colors.primary;
                    ctx.fillRect(1, 76 + bobOffset, 16, 12);
                    ctx.fillRect(63, 76 + bobOffset, 16, 12);
                }
                
                // Shoulder pads with shine
                ctx.fillStyle = this.colors.secondary;
                ctx.fillRect(10, 38, 14, 16);
                ctx.fillRect(56, 38, 14, 16);
                
                if (!isTrail) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fillRect(11, 39, 6, 6);
                    ctx.fillRect(57, 39, 6, 6);
                }
                
                // Head with more detail
                ctx.fillStyle = this.colors.skin;
                ctx.fillRect(26, 12, 28, 32);
                
                // Mask/Hood
                ctx.fillStyle = this.colors.primary;
                ctx.fillRect(24, 6, 32, 14);
                ctx.fillRect(22, 12, 4, 18);
                ctx.fillRect(54, 12, 4, 18);
                ctx.fillRect(24, 32, 32, 10);
                
                // Eyes with glow
                const eyeGlow = !isTrail && this.state === STATE.SPECIAL;
                if (eyeGlow) {
                    ctx.fillStyle = this.colors.secondary;
                    ctx.globalAlpha = 0.8;
                    ctx.fillRect(36, 14, 12, 8);
                    ctx.globalAlpha = 1;
                }
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(38, 16, 10, 6);
                ctx.fillStyle = '#000000';
                ctx.fillRect(40, 17, 4, 4);
                
                if (eyeGlow) {
                    ctx.fillStyle = this.colors.secondary;
                    ctx.fillRect(39, 16, 6, 6);
                }
                
                ctx.restore();
            }
        }

        const player1 = new Fighter(150, 430, 'SCORPION', {
            primary: '#FF8C00',
            secondary: '#FFD700',
            skin: '#D4A574'
        }, {
            left: 'a',
            right: 'd',
            jump: 'w',
            duck: 's',
            punch: 'j',
            kick: 'k',
            special: 'l'
        }, true);

        const player2 = new Fighter(800, 430, 'SUB-ZERO', {
            primary: '#4169E1',
            secondary: '#00FFFF',
            skin: '#D4A574'
        }, {
            left: 'arrowleft',
            right: 'arrowright',
            jump: 'arrowup',
            duck: 'arrowdown',
            punch: '1',
            kick: '2',
            special: '3'
        }, false);

        function drawBackground() {
            // Animated sky
            const skyGrad = ctx.createLinearGradient(0, 0, 0, 500);
            skyGrad.addColorStop(0, '#0a0a2e');
            skyGrad.addColorStop(0.5, '#1a1a3e');
            skyGrad.addColorStop(1, '#2a1a4e');
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, 1000, 500);
            
            // Distant mountains with atmospheric perspective
            ctx.fillStyle = '#0f0f2e';
            ctx.globalAlpha = 0.6;
            ctx.beginPath();
            ctx.moveTo(0, 420);
            ctx.lineTo(150, 320);
            ctx.lineTo(300, 380);
            ctx.lineTo(450, 300);
            ctx.lineTo(600, 360);
            ctx.lineTo(750, 290);
            ctx.lineTo(900, 350);
            ctx.lineTo(1000, 310);
            ctx.lineTo(1000, 500);
            ctx.lineTo(0, 500);
            ctx.fill();
            ctx.globalAlpha = 1;
            
            // Closer mountains
            ctx.fillStyle = '#1a1a3e';
            ctx.beginPath();
            ctx.moveTo(0, 450);
            ctx.lineTo(200, 350);
            ctx.lineTo(400, 410);
            ctx.lineTo(600, 330);
            ctx.lineTo(800, 400);
            ctx.lineTo(1000, 360);
            ctx.lineTo(1000, 500);
            ctx.lineTo(0, 500);
            ctx.fill();
            
            // Moon with glow
            ctx.save();
            ctx.shadowColor = 'rgba(255, 255, 200, 0.8)';
            ctx.shadowBlur = 40;
            ctx.fillStyle = '#f5f5dc';
            ctx.beginPath();
            ctx.arc(850, 120, 55, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
            
            // Moon craters
            ctx.fillStyle = 'rgba(200, 200, 180, 0.3)';
            ctx.beginPath();
            ctx.arc(835, 110, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(860, 125, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Twinkling stars
            ctx.fillStyle = '#ffffff';
            for (let i = 0; i < 80; i++) {
                const x = (i * 173) % 1000;
                const y = (i * 97) % 380;
                const twinkle = Math.sin(Date.now() / 200 + i) > 0.3 ? 1 : 0.3;
                ctx.globalAlpha = twinkle;
                ctx.fillRect(x, y, 2, 2);
            }
            ctx.globalAlpha = 1;
            
            // Arena platform with depth
            const floorGrad = ctx.createLinearGradient(0, 530, 0, 600);
            floorGrad.addColorStop(0, '#3a2a5a');
            floorGrad.addColorStop(1, '#1a1a3a');
            ctx.fillStyle = floorGrad;
            ctx.fillRect(0, 530, 1000, 70);
            
            // Floor tiles with perspective
            ctx.strokeStyle = '#2a1a4a';
            ctx.lineWidth = 3;
            for (let i = 0; i < 1000; i += 70) {
                ctx.strokeRect(i, 530, 70, 70);
            }
            
            // Floor edge highlight
            ctx.fillStyle = 'rgba(138, 43, 226, 0.3)';
            ctx.fillRect(0, 530, 1000, 4);
            
            // Character shadows with blur
            ctx.save();
            ctx.shadowColor = 'rgba(0, 0, 0, 0.6)';
            ctx.shadowBlur = 15;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.beginPath();
            ctx.ellipse(player1.pos.x + 40, 532, 45, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(player2.pos.x + 40, 532, 45, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        function updateHealthBars() {
            const h1 = document.getElementById('health1');
            const h2 = document.getElementById('health2');
            
            const p1Percent = (player1.health / player1.maxHealth) * 100;
            const p2Percent = (player2.health / player2.maxHealth) * 100;
            
            h1.style.width = p1Percent + '%';
            h2.style.width = p2Percent + '%';
            
            h1.className = 'health-bar-inner' + (p1Percent < 30 ? ' critical' : p1Percent < 50 ? ' low' : '');
            h2.className = 'health-bar-inner' + (p2Percent < 30 ? ' critical' : p2Percent < 50 ? ' low' : '');
        }

        function checkWinCondition() {
            if (player1.health <= 0) {
                endGame('SUB-ZERO WINS!');
            } else if (player2.health <= 0) {
                endGame('SCORPION WINS!');
            }
        }

        function endGame(message) {
            game.state = 'ended';
            game.winner = message;
            const winEl = document.getElementById('winText');
            winEl.textContent = message;
            winEl.style.display = 'block';
            
            // Victory explosion
            for (let i = 0; i < 100; i++) {
                particles.push(new Particle(
                    500, 300,
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 20 - 5,
                    ['#FFD700', '#FF0000', '#FFFF00'][Math.floor(Math.random() * 3)],
                    60,
                    6 + Math.random() * 6,
                    Math.random() > 0.5 ? 'circle' : 'square'
                ));
            }
        }

        function showRoundText() {
            const rt = document.getElementById('roundText');
            rt.classList.add('show-text');
            setTimeout(() => {
                rt.classList.remove('show-text');
                game.state = 'playing';
            }, 2000);
        }

        function updateFPS() {
            frames++;
            const currentTime = performance.now();
            fpsTime += currentTime - lastTime;
            lastTime = currentTime;
            
            if (fpsTime >= 1000) {
                fps = frames;
                document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;
                frames = 0;
                fpsTime = 0;
            }
        }

        function gameLoop() {
            updateFPS();
            
            ctx.clearRect(0, 0, 1000, 600);
            
            drawBackground();
            
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if (particles[i].isDead()) {
                    particles.splice(i, 1);
                }
            }
            
            if (game.state === 'playing') {
                player1.update(player2);
                player2.update(player1);
            }
            
            player1.draw();
            player2.draw();
            
            requestAnimationFrame(gameLoop);
        }

        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            keys[key] = true;
            
            if (!keyPressed[key]) {
                keyPressed[key] = true;
            }
            
            if (key === 'd' && e.ctrlKey) {
                e.preventDefault();
                game.debug = !game.debug;
                document.getElementById('debugToggle').textContent = 
                    `DEBUG: ${game.debug ? 'ON' : 'OFF'} (Ctrl+D)`;
            }
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            keys[key] = false;
            keyPressed[key] = false;
        });

        let timerInterval = setInterval(() => {
            if (game.state === 'playing') {
                game.timer--;
                const timerEl = document.getElementById('timer');
                timerEl.textContent = game.timer;
                
                if (game.timer <= 10) {
                    timerEl.classList.add('warning');
                }
                
                if (game.timer <= 0) {
                    if (player1.health > player2.health) {
                        endGame('SCORPION WINS!');
                    } else if (player2.health > player1.health) {
                        endGame('SUB-ZERO WINS!');
                    } else {
                        endGame('DRAW!');
                    }
                }
            }
        }, 1000);

        updateHealthBars();
        showRoundText();
        gameLoop();
    </script>
</body>
</html>